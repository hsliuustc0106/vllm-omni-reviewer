# PR #1405: [Bugfix] Fix tuple/list KV cache extraction crash

## Summary

**Author:** junuxyz | **Fixes:** #1149 | **Files changed:** 2

Fixes a crash on NPU (Ascend 910B) where KV cache is provided as tuple(key, value) per layer instead of a stacked [2, ...] tensor. The original code called .shape on the tuple directly.

### Approach
- New _normalize_layer_kv method handles both stacked tensor and tuple layouts
- Extraction loop refactored to work on separate key_blocks/value_blocks
- Defensive validation at multiple levels with warnings for invalid inputs
- Mismatched block counts truncated to min with warning

### Review Notes
- Clean separation of concerns, good test coverage for tuple and mismatch paths
- TypeAlias import works but is deprecated in 3.12; plain assignment would suffice
- Mismatch truncation is acceptable but downstream has no signal that data is partial
- No negative tests for _normalize_layer_kv rejection paths (nice-to-have)

### Verdict: Approve
Well-scoped bugfix, backward compatible, addresses #1149 directly.

